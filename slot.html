<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒ­ãƒƒãƒˆ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav>
            <a href="shop.html"><img src="shop_icon.png" alt="Shop">ã‚·ãƒ§ãƒƒãƒ—</a>
            <a href="slot.html" class="active"><img src="slot_icon.png" alt="???">ï¼Ÿï¼Ÿï¼Ÿ</a>
        </nav>

        <div id="user-badge">
            <span id="display-team"></span>ï¼š<strong id="display-name"></strong> ã•ã‚“
            <a href="#" id="logout-link">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
        </div>

        <div class="point-box">ãƒãƒ¼ãƒ æ‰€æŒ: <span id="points">--</span> P</div>
        
        <div style="text-align: center; margin-bottom: 10px;">
            <input type="number" id="bet" value="10" min="10" style="width: 70px; padding: 5px; font-size: 1.2em;"> P è³­ã‘ã‚‹
        </div>
        
        <button id="start-btn">START SPIN!</button>

        <div class="slot-machine-wrapper">
            <div class="reels-container">
                <div id="r0" class="reel">?</div>
                <div id="r1" class="reel">?</div>
                <div id="r2" class="reel">?</div>
            </div>
            <div class="buttons-container">
                <button id="stop0" class="stop-btn" disabled>STOP</button>
                <button id="stop1" class="stop-btn" disabled>STOP</button>
                <button id="stop2" class="stop-btn" disabled>STOP</button>
            </div>
        </div>
        <p id="msg" style="text-align: center; font-weight: bold; font-size: 1.4em; min-height: 1.5em; color: #d9534f;"></p>
    </div>
    <div id="toast" class="toast-err"></div>

    <script type="module">
        import { db, getUserInfo, SLOT_WEBHOOK_URL } from './config.js';
        import { ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const user = getUserInfo();
        if (user) {
            document.getElementById('display-team').innerText = user.teamName;
            document.getElementById('display-name').innerText = user.name;
            onValue(ref(db, `teams/${user.teamId}/points`), s => document.getElementById('points').innerText = s.val() || 0);
        }

        const symbols = ["ğŸ’", "ğŸ””", "ğŸ‰", "â­", "7ï¸âƒ£"];
        let intervals = [null, null, null];
        let results = [null, null, null];
        let isPlaying = false;
        let currentSettings = {};

        // ç¢ºç‡è¨­å®šã‚’Firebaseã‹ã‚‰å¸¸æ™‚å–å¾—
        onValue(ref(db, 'settings'), s => { currentSettings = s.val() || {}; });

        // ç¾åœ¨ã®å‹ç‡ã‚’è¨ˆç®— (æ™‚é–“é€£å‹• or æ‰‹å‹•)
        function getWinRate() {
            if (currentSettings.mode === "manual") return currentSettings.manual_rate;
            const now = new Date();
            const ratio = (now.getHours() * 60 + now.getMinutes()) / 1439;
            return currentSettings.auto_min + (currentSettings.auto_max - currentSettings.auto_min) * ratio;
        }

const startBtn = document.getElementById('start-btn');
const stopBtns = [
    document.getElementById('stop0'), 
    document.getElementById('stop1'), 
    document.getElementById('stop2')
];

startBtn.onclick = () => {
    if (isPlaying) return;
    const bet = parseInt(document.getElementById('bet').value);
    if (isNaN(bet) || bet < 10) return showToast("10Pã‹ã‚‰ã®ã¿è³­ã‘ã‚‰ã‚Œã¾ã™");

    runTransaction(ref(db, `teams/${user.teamId}/points`), p => {
        if (p < bet) return; 
        return p - bet;
    }).then(res => {
        if(!res.committed) return showToast("ãƒã‚¤ãƒ³ãƒˆä¸è¶³ã§ã™");
        
        isPlaying = true; 
        startBtn.disabled = true;
        document.getElementById('msg').innerText = "å›è»¢ä¸­...";
        
        // å…¨ãƒªãƒ¼ãƒ«ã‚’å›è»¢ã•ã›ã‚‹
        intervals.forEach((_, i) => {
            results[i] = null; // çµæœã‚’ãƒªã‚»ãƒƒãƒˆ
            intervals[i] = setInterval(() => {
                document.getElementById(`r${i}`).innerText = symbols[Math.floor(Math.random() * symbols.length)];
            }, 80);
            
            stopBtns[i].disabled = true;
            stopBtns[i].onclick = () => stopReel(i);
        });

        // 1ç•ªç›®ã®ãƒœã‚¿ãƒ³ã ã‘ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        stopBtns[0].disabled = false;
    });
};

function stopReel(i) {
    if (!intervals[i]) return;
    clearInterval(intervals[i]); 
    intervals[i] = null;
    stopBtns[i].disabled = true;

    if (i === 2) {
        const winRate = getWinRate(); // 0 ï½ 100
        const dice = Math.random() * 100;

        const r0 = document.getElementById('r0').innerText;
        const r1 = document.getElementById('r1').innerText;
        let r2 = document.getElementById('r2').innerText;

        if (dice < winRate) {
            r2 = r0; 
            document.getElementById('r2').innerText = r2;
        } else {
            while (r2 === r0 || r2 === r1) {
                r2 = symbols[Math.floor(Math.random() * symbols.length)];
            }
            document.getElementById('r2').innerText = r2;
        }
        
        results = [0, 1, 2].map(idx => symbols.indexOf(document.getElementById(`r${idx}`).innerText));
        checkResult();
    } else {
        stopBtns[i + 1].disabled = false;
    }
}

function checkResult() {
            const bet = parseInt(document.getElementById('bet').value);
            let win = 0; let label = "æ®‹å¿µ...";
            
            if (results[0] === results[1] && results[1] === results[2]) {
                win = results[0] === 4 ? bet * 10 : bet * 3;
                label = "ğŸŠ å¤§å½“ãŸã‚Šï¼";
            } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                win = Math.floor(bet * 1.5);
                label = "âœ¨ å½“ãŸã‚Š";
            }
            document.getElementById('msg').innerText = win > 0 ? `${label} (+${win}P)` : label;

            updatePersonalStats(bet, win);

            // Webhooké€šçŸ¥ (ã‚¹ãƒ­ãƒƒãƒˆå°‚ç”¨)
            fetch(SLOT_WEBHOOK_URL, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ content: `ğŸ° **SLOT**: ${user.teamName}ã®${user.name}ã•ã‚“ã®çµæœ: ${label} (è³­ã‘:${bet} / ç²å¾—:${win})` })
            });

            // å½“ãŸã£ãŸå ´åˆã¯ãƒãƒ¼ãƒ ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°
            if (win > 0) runTransaction(ref(db, `teams/${user.teamId}/points`), p => (p || 0) + win);
            
            isPlaying = false; 
            startBtn.disabled = false;
        }

        function updatePersonalStats(bet, win) {
            const statsRef = ref(db, `user_stats/${user.id}`);
            runTransaction(statsRef, (current) => {
                if (current === null) {
                    return { total_bet: bet, total_win: win, counter:1 };
                }
                return {
                    total_bet: (current.total_bet || 0) + bet,
                    total_win: (current.total_win || 0) + win,
                    counter: (current.counter || 0) + 1
                };
            });
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            if (!t) return;
        
            t.innerText = msg;
            t.classList.add('show');
            
            // 3ç§’å¾Œã«æ¶ˆã™
            setTimeout(() => {
                t.classList.remove('show');
            }, 3000);
        }
        
        document.getElementById('logout-link').onclick = () => { localStorage.removeItem('userId'); window.location.href = 'login.html'; };
    </script>
</body>
</html>
