<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¹ãƒ­ãƒƒãƒˆ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .slot-container { display: flex; gap: 10px; justify-content: center; font-size: 3rem; margin: 20px 0; }
        .reel { width: 80px; height: 100px; border: 2px solid #333; display: flex; align-items: center; justify-content: center; background: #fff; border-radius: 8px; }
        #user-badge { text-align: right; padding: 10px; font-size: 0.9em; color: #555; background: #eee; border-radius: 5px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div id="user-badge">
            <span id="display-team"></span>ï¼š<strong id="display-name"></strong> ã•ã‚“
        </div>

        <nav><a href="shop.html">ã‚·ãƒ§ãƒƒãƒ—</a> | <a href="slot.html">ã‚¹ãƒ­ãƒƒãƒˆ</a></nav>
        <h2>ãƒã‚¤ãƒ³ãƒˆã‚¹ãƒ­ãƒƒãƒˆ</h2>
        
        <div class="point-box">æ‰€æŒ: <span id="points">--</span> P</div>
        
        <div style="margin: 20px 0;">
            <input type="number" id="bet" value="10" min="10" style="width: 80px; padding: 5px;"> P è³­ã‘ã‚‹
        </div>
        
        <div class="slot-container">
            <div id="r1" class="reel">?</div>
            <div id="r2" class="reel">?</div>
            <div id="r3" class="reel">?</div>
        </div>

        <button id="action-btn" style="width: 100%; font-size: 1.2em;">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        <p id="msg" style="text-align: center; font-weight: bold; font-size: 1.2em; margin-top: 15px;"></p>
    </div>

    <script type="module">
        import { db, getUserInfo, DISCORD_WEBHOOK_URL } from './config.js';
        import { ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // 1. ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã®å–å¾—
        const user = getUserInfo();
        if (user) {
            document.getElementById('display-team').innerText = user.teamName;
            document.getElementById('display-name').innerText = user.name;
            
            // ãƒã‚¤ãƒ³ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
            onValue(ref(db, `teams/${user.teamId}/points`), (s) => {
                document.getElementById('points').innerText = s.val() || 0;
            });
        }

        const symbols = ["ğŸ’", "ğŸ””", "ğŸ‰", "â­", "7ï¸âƒ£"];
        let status = "ready"; 
        let intervals = [null, null, null];
        let results = [0, 0, 0];

        const btn = document.getElementById('action-btn');
        btn.onclick = () => {
            if (status === "ready") startSlot();
            else if (status === "spinning" || status.startsWith("stop")) stopNextReel();
        };

        function startSlot() {
            const bet = parseInt(document.getElementById('bet').value);
            if (isNaN(bet) || bet < 10) return alert("10Pä»¥ä¸Šè³­ã‘ã¦ãã ã•ã„");

            const pRef = ref(db, `teams/${user.teamId}/points`);

            runTransaction(pRef, (p) => {
                if (p < bet) return; // ãƒã‚¤ãƒ³ãƒˆä¸è¶³
                return p - bet; 
            }).then(res => {
                if(!res.committed) return alert("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
                
                status = "spinning";
                btn.innerText = "1ç•ªç›®ã‚’æ­¢ã‚ã‚‹ï¼";
                document.getElementById('msg').innerText = "å›è»¢ä¸­...";
                
                intervals.forEach((_, i) => {
                    intervals[i] = setInterval(() => {
                        results[i] = Math.floor(Math.random() * symbols.length);
                        document.getElementById(`r${i+1}`).innerText = symbols[results[i]];
                    }, 100);
                });
            });
        }

        function stopNextReel() {
            if (intervals[0]) {
                clearInterval(intervals[0]); intervals[0] = null;
                btn.innerText = "2ç•ªç›®ã‚’æ­¢ã‚ã‚‹ï¼";
            } else if (intervals[1]) {
                clearInterval(intervals[1]); intervals[1] = null;
                btn.innerText = "3ç•ªç›®ã‚’æ­¢ã‚ã‚‹ï¼";
            } else if (intervals[2]) {
                clearInterval(intervals[2]); intervals[2] = null;
                checkResult();
            }
        }

        function checkResult() {
            const bet = parseInt(document.getElementById('bet').value);
            let win = 0;
            let resultLabel = "ãƒã‚ºãƒ¬";

            // åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
            if (results[0] === results[1] && results[1] === results[2]) {
                win = results[0] === 4 ? bet * 10 : bet * 5; 
                resultLabel = "ğŸŠ å¤§å½“ãŸã‚Š";
            } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                win = Math.floor(bet * 1.5);
                resultLabel = "âœ¨ å½“ãŸã‚Š";
            }

            document.getElementById('msg').innerText = `${resultLabel}ï¼ ${win}P ç²å¾—ï¼`;

            // 2. çµæœã«ä¾ã‚‰ãšDiscordã¸é€šçŸ¥ã‚’é£›ã°ã™
            const discordMsg = `ğŸ° **ã‚¹ãƒ­ãƒƒãƒˆãƒ­ã‚°**\nâ”â”â”â”â”â”â”â”â”â”â”â”\n**ãƒãƒ¼ãƒ **: ${user.teamName}\n**åå‰**: ${user.name} ã•ã‚“\n**çµæœ**: ${resultLabel}\n**ä½¿ç”¨**: ${bet} P / **ç²å¾—**: ${win} P`;
            
            fetch(DISCORD_WEBHOOK_URL, {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ content: discordMsg })
            });

            // å½“ãŸã£ãŸå ´åˆã¯ãƒã‚¤ãƒ³ãƒˆã‚’DBã«æˆ»ã™
            if (win > 0) {
                runTransaction(ref(db, `teams/${user.teamId}/points`), p => (p || 0) + win);
            }

            btn.innerText = "ã‚‚ã†ä¸€åº¦éŠã¶";
            status = "ready";
        }
    </script>
</body>
</html>
