<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><title>ã‚¹ãƒ­ãƒƒãƒˆ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .slot-container { display: flex; gap: 10px; justify-content: center; font-size: 3rem; margin: 20px 0; }
        .reel { width: 80px; height: 100px; border: 2px solid #333; display: flex; align-items: center; justify-content: center; background: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <nav><a href="shop.html">ã‚·ãƒ§ãƒƒãƒ—</a> | <a href="slot.html">ã‚¹ãƒ­ãƒƒãƒˆ</a></nav>
        <h2>ãƒã‚¤ãƒ³ãƒˆã‚¹ãƒ­ãƒƒãƒˆ</h2>
        <div class="point-box">æ‰€æŒ: <span id="points">--</span> P</div>
        
        <input type="number" id="bet" value="10" min="10"> P è³­ã‘ã‚‹
        
        <div class="slot-container">
            <div id="r1" class="reel">?</div>
            <div id="r2" class="reel">?</div>
            <div id="r3" class="reel">?</div>
        </div>

        <button id="action-btn">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        <p id="msg"></p>
    </div>

    <script type="module">
        import { db, getLoggedInTeam } from './config.js';
        import { ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const teamId = getLoggedInTeam();
        const symbols = ["ğŸ’", "ğŸ””", "ğŸ‰", "â­", "7ï¸âƒ£"];
        let status = "ready"; // ready -> spinning -> stop1 -> stop2 -> result
        let intervals = [null, null, null];
        let results = [0, 0, 0];

        onValue(ref(db, `teams/${teamId}/points`), (s) => {
            document.getElementById('points').innerText = s.val() || 0;
        });

        const btn = document.getElementById('action-btn');
        btn.onclick = () => {
            if (status === "ready") startSlot();
            else if (status.startsWith("spin") || status.startsWith("stop")) stopNextReel();
        };

        function startSlot() {
            const bet = parseInt(document.getElementById('bet').value);
            const pRef = ref(db, `teams/${teamId}/points`);

            runTransaction(pRef, (p) => {
                if (p < bet) return;
                return p - bet;
            }).then(res => {
                if(!res.committed) return alert("ãƒã‚¤ãƒ³ãƒˆä¸è¶³");
                
                status = "spinning";
                btn.innerText = "1ç•ªç›®ã‚’æ­¢ã‚ã‚‹ï¼";
                intervals.forEach((_, i) => {
                    intervals[i] = setInterval(() => {
                        results[i] = Math.floor(Math.random() * symbols.length);
                        document.getElementById(`r${i+1}`).innerText = symbols[results[i]];
                    }, 100);
                });
            });
        }

        function stopNextReel() {
            if (intervals[0]) {
                clearInterval(intervals[0]); intervals[0] = null;
                btn.innerText = "2ç•ªç›®ã‚’æ­¢ã‚ã‚‹ï¼";
            } else if (intervals[1]) {
                clearInterval(intervals[1]); intervals[1] = null;
                btn.innerText = "3ç•ªç›®ã‚’æ­¢ã‚ã‚‹ï¼";
            } else if (intervals[2]) {
                clearInterval(intervals[2]); intervals[2] = null;
                checkResult();
            }
        }

        function checkResult() {
            const bet = parseInt(document.getElementById('bet').value);
            let win = 0;
            if (results[0] === results[1] && results[1] === results[2]) {
                win = results[0] === 4 ? bet * 10 : bet * 5; // 7æƒã„ã¯10å€
                document.getElementById('msg').innerText = `å¤§å½“ãŸã‚Šï¼ ${win}Pç²å¾—ï¼`;
            } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                win = Math.floor(bet * 1.5);
                document.getElementById('msg').innerText = `å°å½“ãŸã‚Šï¼ ${win}Pç²å¾—ï¼`;
            } else {
                document.getElementById('msg').innerText = "æ®‹å¿µ...";
            }

            if (win > 0) {
                runTransaction(ref(db, `teams/${teamId}/points`), p => (p || 0) + win);
            }
            btn.innerText = "å†æŒ‘æˆ¦";
            status = "ready";
        }
    </script>
</body>
</html>
