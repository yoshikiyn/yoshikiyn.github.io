<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çπ„É≠„ÉÉ„Éà„Ç≤„Éº„É†</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav>
            <a href="shop.html">
                <img src="shop_icon.png" alt="„Ç∑„Éß„ÉÉ„Éó">
                „Ç∑„Éß„ÉÉ„Éó
            </a>
            <a href="slot.html" class="active">
                <img src="slot_icon.png" alt="„Çπ„É≠„ÉÉ„Éà">
                „Çπ„É≠„ÉÉ„Éà
            </a>
        </nav>

        <div id="user-badge">
            <span id="display-team"></span>Ôºö<strong id="display-name"></strong> „Åï„Çì
        </div>

        <h2>„Éù„Ç§„É≥„Éà„Çπ„É≠„ÉÉ„Éà</h2>
        <div class="point-box">ÊâÄÊåÅ: <span id="points">--</span> P</div>
        
        <div style="text-align: center; margin-bottom: 15px;">
            <input type="number" id="bet" value="10" min="10" style="width: 80px; padding: 8px; font-size: 1.2em; text-align: center;"> P Ë≥≠„Åë„Çã
        </div>
        
        <button id="start-btn">START SPIN!</button>

        <div class="slot-machine-wrapper">
            <div class="reels-container">
                <div id="r0" class="reel">?</div>
                <div id="r1" class="reel">?</div>
                <div id="r2" class="reel">?</div>
            </div>
            <div class="buttons-container">
                <button id="stop0" class="stop-btn" disabled>STOP</button>
                <button id="stop1" class="stop-btn" disabled>STOP</button>
                <button id="stop2" class="stop-btn" disabled>STOP</button>
            </div>
        </div>
        
        <p id="msg" style="text-align: center; font-weight: bold; font-size: 1.5em; min-height: 1.5em;"></p>
    </div>

    <script type="module">
        // ‚ñº‚ñº‚ñº SLOT_WEBHOOK_URL „Çí„Ç§„É≥„Éù„Éº„Éà ‚ñº‚ñº‚ñº
        import { db, getUserInfo, SLOT_WEBHOOK_URL } from './config.js';
        import { ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const user = getUserInfo();
        if (user) {
            document.getElementById('display-team').innerText = user.teamName;
            document.getElementById('display-name').innerText = user.name;
            onValue(ref(db, `teams/${user.teamId}/points`), s => document.getElementById('points').innerText = s.val() || 0);
        }

        const symbols = ["üçí", "üîî", "üçâ", "‚≠ê", "7Ô∏è‚É£"];
        let intervals = [null, null, null];
        let results = [null, null, null];
        let isPlaying = false;

        const startBtn = document.getElementById('start-btn');
        const stopBtns = [document.getElementById('stop0'), document.getElementById('stop1'), document.getElementById('stop2')];

        // „Çπ„Çø„Éº„Éà„Éú„Çø„É≥
        startBtn.onclick = () => {
            if (isPlaying) return;
            const bet = parseInt(document.getElementById('bet').value);
            if (isNaN(bet) || bet < 10) return alert("10P‰ª•‰∏äË≥≠„Åë„Å¶„Åè„Å†„Åï„ÅÑ");

            runTransaction(ref(db, `teams/${user.teamId}/points`), p => {
                if (p === null || p < bet) return; return p - bet;
            }).then(res => {
                if(!res.committed) return alert("„Éù„Ç§„É≥„Éà„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ");
                
                isPlaying = true;
                startBtn.disabled = true;
                startBtn.innerText = "ÂõûËª¢‰∏≠...";
                document.getElementById('msg').innerText = "";
                results = [null, null, null];

                // „É™„Éº„É´ÂõûËª¢ÈñãÂßã & „Éú„Çø„É≥ÊúâÂäπÂåñ
                intervals.forEach((_, i) => {
                    document.getElementById(`r${i}`).innerText = symbols[Math.floor(Math.random() * symbols.length)];
                    intervals[i] = setInterval(() => {
                        document.getElementById(`r${i}`).innerText = symbols[Math.floor(Math.random() * symbols.length)];
                    }, 80); // ÂõûËª¢ÈÄüÂ∫¶UP
                    stopBtns[i].disabled = false;
                    stopBtns[i].onclick = () => stopReel(i);
                });
            });
        };

        // ÂÄãÂà•„Çπ„Éà„ÉÉ„Éó„Éú„Çø„É≥
        function stopReel(index) {
            if (intervals[index]) {
                clearInterval(intervals[index]);
                intervals[index] = null;
                // Ê≠¢„Åæ„Å£„ÅüÁµµÊüÑ„ÇíË®òÈå≤
                results[index] = symbols.indexOf(document.getElementById(`r${index}`).innerText);
                stopBtns[index].disabled = true;

                // ÂÖ®„Å¶Ê≠¢„Åæ„Å£„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (results.every(r => r !== null)) {
                    checkResult();
                }
            }
        }

        // ÁµêÊûúÂà§ÂÆö
        function checkResult() {
            const bet = parseInt(document.getElementById('bet').value);
            let win = 0;
            let resultLabel = "„Éè„Ç∫„É¨...";

            if (results[0] === results[1] && results[1] === results[2]) {
                win = results[0] === 4 ? bet * 10 : bet * 3; // 7ÊèÉ„ÅÑ„ÅØ10ÂÄç„ÄÅ‰ªñ„ÅØ3ÂÄç
                resultLabel = "üéâ ÂΩì„Åü„Çä";
            }/* else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                win = Math.floor(bet * 1.2);
                resultLabel = "‚ú® Â∞èÂΩì„Åü„Çä";
            }*/

            document.getElementById('msg').innerText = win > 0 ? `${resultLabel} (+${win}P)` : resultLabel;

            // „Çπ„É≠„ÉÉ„ÉàÂ∞ÇÁî®Webhook„Å∏ÈÄöÁü•
            fetch(SLOT_WEBHOOK_URL, {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ content: `üé∞ **„Çπ„É≠„ÉÉ„ÉàÁµêÊûú**: ${user.teamName} „ÅÆ ${user.name} „Åï„Çì\nÁµêÊûú: ${resultLabel} (BET:${bet} -> GET:${win})` })
            });

            if (win > 0) {
                runTransaction(ref(db, `teams/${user.teamId}/points`), p => (p || 0) + win);
            }
            isPlaying = false;
            startBtn.disabled = false;
            startBtn.innerText = "START SPIN!";
        }
    </script>
</body>
</html>
