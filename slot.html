<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLOT GAME</title>
    <link rel="stylesheet" href="style.css">
</head>
<style>
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .container {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.5s;
    }
    /* Ëß£Èô§ÊôÇ„Å´Ë°®Á§∫„Åô„Çã„Åü„ÇÅ„ÅÆ„ÇØ„É©„Çπ */
    .container.is-visible {
        visibility: visible;
        opacity: 1;
    }
</style>
<body>
    <div id="slot-lock-overlay" class="modal-overlay">
        <div class="modal-card">
            <h3>???? UNLOCK</h3>
            <p>„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <input type="text" id="slot-pw-input" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ..." 
                   style="width: 85%; padding: 12px; margin: 15px 0; font-size: 1.1em; text-align: center; border: 2px solid #ddd; border-radius: 8px;">
            
            <div class="modal-btns" style="flex-direction: column; gap: 10px;">
                <button id="unlock-btn" class="btn-primary" style="width: 100%; padding: 12px;">Ëß£Èô§</button>
                <button id="lock-back-btn" class="btn-secondary" style="width: 100%; padding: 10px; font-size: 0.9em;">
                    „Ç∑„Éß„ÉÉ„Éó„Å∏Êàª„Çã
                </button>
            </div>
            <p id="lock-error" style="color: #d9534f; font-size: 0.8em; margin-top: 10px;"></p>
        </div>
    </div>

    <div class="container">
        <nav>
            <a href="shop.html"><img src="shop_icon.png" alt="Shop">„Ç∑„Éß„ÉÉ„Éó</a>
            <a href="slot.html" class="active"><img src="slot_icon.png" alt="Slot">„Çπ„É≠„ÉÉ„Éà</a>
        </nav>

        <div id="user-badge">
            <span id="display-team"></span>Ôºö<strong id="display-name"></strong> „Åï„Çì
            <a href="#" id="logout-link">„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
        </div>

        <div class="point-box">„ÉÅ„Éº„É†ÊâÄÊåÅ: <span id="points">--</span> P</div>
        
        <div style="text-align: center; margin-bottom: 10px;">
            <input type="number" id="bet" value="10" min="10" style="width: 70px; padding: 5px; font-size: 1.2em;"> P Ë≥≠„Åë„Çã
        </div>
        
        <button id="start-btn">START SPIN!</button>

        <div class="slot-machine-wrapper">
            <div class="reels-container">
                <div id="r0" class="reel">?</div>
                <div id="r1" class="reel">?</div>
                <div id="r2" class="reel">?</div>
            </div>
            <div class="buttons-container">
                <button id="stop0" class="stop-btn" disabled>STOP</button>
                <button id="stop1" class="stop-btn" disabled>STOP</button>
                <button id="stop2" class="stop-btn" disabled>STOP</button>
            </div>
        </div>
        <p id="msg" style="text-align: center; font-weight: bold; font-size: 1.4em; min-height: 1.5em; color: #d9534f;"></p>
    </div>
    <div id="toast" class="toast-err"></div>

    <script type="module">
        import { db, getUserInfo, SLOT_WEBHOOK_URL } from './config.js';
        import { ref, onValue, runTransaction, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const user = getUserInfo();
        if (!user) {
            window.location.href = 'login.html';
        } else {
            initSlotPage();
        }

        async function initSlotPage() {
            const SECRET_PW = "password"; 
            const unlockRef = ref(db, `user_stats/${user.id}/slot_unlocked`);
            const pointsRef = ref(db, `teams/${user.teamId}/points`);
            
            const overlay = document.getElementById('slot-lock-overlay');
            const container = document.querySelector('.container');
            const lockError = document.getElementById('lock-error');

            // --- ‰øÆÊ≠£„Éù„Ç§„É≥„ÉàÔºö„Çª„ÉÉ„Ç∑„Éß„É≥ÂÜÖ„Éï„É©„Ç∞ ---
            let isAlreadyUnlockedInThisSession = false;

            // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅÆË°®Á§∫
            document.getElementById('display-team').innerText = user.teamName;
            document.getElementById('display-name').innerText = user.name;
            
            // Ëß£Èô§Áä∂ÊÖã„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü
            onValue(unlockRef, (s) => {
                // „Åô„Åß„Å´Ëß£Èô§Ê∏à„Åø„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Åù„ÅÆÂæå„ÅÆDBÂ§âÂãïÔºà„Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥‰∏≠„ÅÆÁ©∫„Éá„Éº„ÇøÁ≠âÔºâ„ÇíÁÑ°Ë¶ñ„Åô„Çã
                if (isAlreadyUnlockedInThisSession) return;

                const isUnlocked = s.val() === true;
                if (isUnlocked) {
                    isAlreadyUnlockedInThisSession = true;
                    if(overlay) overlay.style.display = 'none';
                    if(container) container.classList.add('is-visible');
                } else {
                    if(overlay) overlay.style.display = 'flex';
                }
            });

            // „ÉÅ„Éº„É†„Éù„Ç§„É≥„Éà„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü
            onValue(pointsRef, (snapshot) => {
                const currentPoints = snapshot.val() || 0;
                document.getElementById('points').innerText = currentPoints.toLocaleString();
            });

            // Ëß£Èô§„Éú„Çø„É≥
            document.getElementById('unlock-btn').onclick = () => {
                const val = document.getElementById('slot-pw-input').value;
                if (val === SECRET_PW) {
                    set(unlockRef, true);
                } else {
                    lockError.innerText = "„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô";
                }
            };

            document.getElementById('lock-back-btn').onclick = () => { window.location.href = 'shop.html'; };
        }

        // --- „Çπ„É≠„ÉÉ„Éà„É≠„Ç∏„ÉÉ„ÇØ ---
        const symbols = ["üçí", "üîî", "üçâ", "‚≠ê", "7Ô∏è‚É£"];
        let intervals = [null, null, null];
        let results = [null, null, null];
        let isPlaying = false;
        let currentSettings = {};

        onValue(ref(db, 'settings'), s => { currentSettings = s.val() || {}; });

        function getWinRate() {
            if (currentSettings.mode === "manual") return currentSettings.manual_rate;
            const now = new Date();
            const ratio = (now.getHours() * 60 + now.getMinutes()) / 1439;
            return (currentSettings.auto_min || 0) + ((currentSettings.auto_max || 0) - (currentSettings.auto_min || 0)) * ratio;
        }

        const startBtn = document.getElementById('start-btn');
        const stopBtns = [
            document.getElementById('stop0'), 
            document.getElementById('stop1'), 
            document.getElementById('stop2')
        ];

        startBtn.onclick = () => {
            if (isPlaying) return;
            const bet = parseInt(document.getElementById('bet').value);
            if (isNaN(bet) || bet < 10) return showToast("10P„Åã„Çâ„ÅÆ„ÅøË≥≠„Åë„Çâ„Çå„Åæ„Åô");

            runTransaction(ref(db, `teams/${user.teamId}/points`), p => {
                if (p < bet) return; 
                return p - bet;
            }).then(res => {
                if(!res.committed) return showToast("„Éù„Ç§„É≥„Éà‰∏çË∂≥„Åß„Åô");
                
                isPlaying = true; 
                startBtn.disabled = true;
                document.getElementById('msg').innerText = "ÂõûËª¢‰∏≠...";
                
                intervals.forEach((_, i) => {
                    results[i] = null;
                    intervals[i] = setInterval(() => {
                        document.getElementById(`r${i}`).innerText = symbols[Math.floor(Math.random() * symbols.length)];
                    }, 80);
                    stopBtns[i].disabled = true;
                    stopBtns[i].onclick = () => stopReel(i);
                });
                stopBtns[0].disabled = false;
            });
        };

        function stopReel(i) {
            if (!intervals[i]) return;
            clearInterval(intervals[i]); 
            intervals[i] = null;
            stopBtns[i].disabled = true;

            if (i === 2) {
                const winRate = getWinRate();
                const dice = Math.random() * 100;
                const r0 = document.getElementById('r0').innerText;
                const r1 = document.getElementById('r1').innerText;
                let r2 = document.getElementById('r2').innerText;

                if (dice < winRate) {
                    r2 = r0; 
                } else {
                    while (r2 === r0 || r2 === r1) {
                        r2 = symbols[Math.floor(Math.random() * symbols.length)];
                    }
                }
                document.getElementById('r2').innerText = r2;
                results = [0, 1, 2].map(idx => symbols.indexOf(document.getElementById(`r${idx}`).innerText));
                checkResult();
            } else {
                stopBtns[i + 1].disabled = false;
            }
        }

        function checkResult() {
            const bet = parseInt(document.getElementById('bet').value);
            let win = 0; let label = "ÊÆãÂøµ...";
            
            if (results[0] === results[1] && results[1] === results[2]) {
                win = results[0] === 4 ? bet * 10 : bet * 3;
                label = "üéä Â§ßÂΩì„Åü„ÇäÔºÅ";
            } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                win = Math.floor(bet * 1.5);
                label = "‚ú® ÂΩì„Åü„Çä";
            }
            document.getElementById('msg').innerText = win > 0 ? `${label} (+${win}P)` : label;

            updatePersonalStats(bet, win);

            fetch(SLOT_WEBHOOK_URL, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ content: `üé∞ **SLOT**: ${user.teamName}„ÅÆ${user.name}„Åï„Çì„ÅÆÁµêÊûú: ${label} (Ë≥≠„Åë:${bet} / Áç≤Âæó:${win})` })
            });

            if (win > 0) runTransaction(ref(db, `teams/${user.teamId}/points`), p => (p || 0) + win);
            
            isPlaying = false; 
            startBtn.disabled = false;
        }

        function updatePersonalStats(bet, win) {
            const statsRef = ref(db, `user_stats/${user.id}`);
            runTransaction(statsRef, (current) => {
                if (current === null) return { total_bet: bet, total_win: win, counter: 1, slot_unlocked: true };
                return {
                    ...current,
                    total_bet: (current.total_bet || 0) + bet,
                    total_win: (current.total_win || 0) + win,
                    counter: (current.counter || 0) + 1
                };
            });
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            if (!t) return;
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => { t.classList.remove('show'); }, 3000);
        }
        
        document.getElementById('logout-link').onclick = () => { localStorage.removeItem('userId'); window.location.href = 'login.html'; };
    </script>
</body>
</html>
