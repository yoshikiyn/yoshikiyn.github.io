<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><title>ã‚·ãƒ§ãƒƒãƒ—</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav><a href="shop.html">ã‚·ãƒ§ãƒƒãƒ—</a> | <a href="slot.html">ã‚¹ãƒ­ãƒƒãƒˆ</a></nav>
        <h2 id="team-display"></h2>
        <div class="point-box">æ‰€æŒãƒã‚¤ãƒ³ãƒˆ: <span id="points">--</span> P</div>

        <div id="item-list" class="item-grid"></div>
    </div>

    <script type="module">
        import { db, getLoggedInTeam, TEAMS, DISCORD_WEBHOOK_URL } from './config.js';
        import { ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const teamId = getLoggedInTeam();
        if (teamId) {
            document.getElementById('team-display').innerText = TEAMS[teamId].name;
            onValue(ref(db, `teams/${teamId}/points`), (s) => {
                document.getElementById('points').innerText = s.val() || 0;
            });
        }

        const ITEMS = [
            { id: 1, name: "ã‚«ãƒƒãƒ—ãƒ©ãƒ¼ãƒ¡ãƒ³", cost: 100, img: "cupnoodle.png" },
            { id: 2, name: "ã‚³ãƒ³ãƒ“ãƒ‹æ¨©åˆ©", cost: 200, img: "lawson.png" },
            { id: 3, name: "Switch", cost: 500, img: "switch.png" }
        ];

        const list = document.getElementById('item-list');
        ITEMS.forEach(item => {
            const div = document.createElement('div');
            div.className = "item-card";
            div.innerHTML = `
                <img src="${item.img}" width="64" height="64" alt="${item.name}">
                <h4>${item.name}</h4>
                <p>${item.cost} P</p>
                <button onclick="buy('${item.name}', ${item.cost})">æ³¨æ–‡ã™ã‚‹</button>
            `;
            list.appendChild(div);
        });

        window.buy = (name, cost) => {
            if(!confirm(`${name}ã‚’è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            const pRef = ref(db, `teams/${teamId}/points`);
            runTransaction(pRef, (p) => {
                if (p < cost) return;
                return p - cost;
            }).then(res => {
                if(res.committed) {
                    fetch(DISCORD_WEBHOOK_URL, {
                        method: "POST", 
                        headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({content: `ğŸ›’ **æ³¨æ–‡**: ${TEAMS[teamId].name}ãŒã€Œ${name}ã€ã‚’è³¼å…¥ã—ã¾ã—ãŸã€‚`})
                    });
                    alert("æ³¨æ–‡ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸï¼");
                } else { alert("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“"); }
            });
        };
    </script>
</body>
</html>
