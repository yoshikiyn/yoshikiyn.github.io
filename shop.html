<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アイテムショップ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav>
            <a href="shop.html" class="active">
                <img src="shop_icon.png" alt="ショップ">
                ショップ
            </a>
            <a href="slot.html">
                <img src="slot_icon.png" alt="スロット">
                スロット
            </a>
        </nav>

        <div id="user-badge">
            <span id="display-team">読み込み中...</span>：<strong id="display-name"></strong> さん
            <a href="#" id="logout-link">ログアウト</a>
        </div>

        <h2>アイテム購入</h2>
        <div class="point-box">チーム所持: <span id="points">--</span> P</div>

        <div id="item-list" class="item-grid"></div>
    </div>

    <div id="custom-confirm" class="modal-overlay" style="display:none;">
        <div class="modal-card">
            <h3 id="confirm-msg">購入しますか？</h3>
            <div class="modal-btns">
                <button id="confirm-yes" class="btn-primary">はい</button>
                <button id="confirm-no" class="btn-secondary">いいえ</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast-msg">購入が完了しました！</div>

    <script type="module">
        // ▼▼▼ SHOP_WEBHOOK_URL をインポート ▼▼▼
        import { db, getUserInfo, SHOP_WEBHOOK_URL } from './config.js';
        import { ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const user = getUserInfo();
        if (user) {
            document.getElementById('display-team').innerText = user.teamName;
            document.getElementById('display-name').innerText = user.name;
            onValue(ref(db, `teams/${user.teamId}/points`), (s) => {
                document.getElementById('points').innerText = s.val() || 0;
            });
        }

        // アイテム定義 
        const ITEMS = [
            { id: 1, name: "湖畔へ車移動", cost: 50, img: "car.png" },
            { id: 2, name: "コンビニ権", cost: 500, img: "lawson.png" },
            { id: 3, name: "カップラーメン", cost: 200, img: "cupnoodle.png" },
            { id: 4, name: "スイッチ", cost: 1000, img: "switch.png" }
        ];

        const listContainer = document.getElementById('item-list');
        ITEMS.forEach(item => {
            listContainer.innerHTML += `
                <div class="item-card">
                    <img src="${item.img}" alt="${item.name}">
                    <h4>${item.name}</h4>
                    <p>${item.cost} P</p>
                    <button onclick="purchase('${item.name}', ${item.cost})">注文する</button>
                </div>
            `;
        });
    
            // 通知を表示する関数
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        // 購入処理をグローバルに公開
        window.buyItem = (itemId, itemName, price) => {
            const modal = document.getElementById('custom-confirm');
            const msgEl = document.getElementById('confirm-msg');
            
            if (!modal || !msgEl) {
                console.error("モーダル用のHTMLが見つかりません。");
                return;
            }
        
            msgEl.innerText = `${itemName} を購入しますか？`;
            modal.style.display = 'flex'; // 表示
        
            // 「はい」をクリック
            document.getElementById('confirm-yes').onclick = () => {
                modal.style.display = 'none';
                
                // Firebaseのポイント更新
                runTransaction(ref(db, `teams/${user.teamId}/points`), (p) => {
                    if (p < price) return;
                    return p - price;
                }).then((res) => {
                    if (!res.committed) {
                        showToast("ポイントが足りません！");
                        return;
                    }
        
                    // Webhook通知
                    fetch(SHOP_WEBHOOK_URL, {
                        method: "POST",
                        headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({ 
                            content: `🛒 **SHOP**: ${user.teamName}の${user.name}さんが「${itemName}」を購入しました！` 
                        })
                    });
        
                    showToast(`${itemName} を購入しました！`);
                }).catch(err => {
                    console.error(err);
                    showToast("エラーが発生しました");
                });
            };
        
            // 「いいえ」をクリック
            document.getElementById('confirm-no').onclick = () => {
                modal.style.display = 'none';
            };
        };
        document.getElementById('logout-link').onclick = () => { localStorage.removeItem('userId'); window.location.href = 'login.html'; };
    </script>
</body>
</html>
