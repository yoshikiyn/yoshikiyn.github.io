<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç¢„Ç§„ÉÜ„É†„Ç∑„Éß„ÉÉ„Éó</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav>
            <a href="shop.html" class="active">
                <img src="shop_icon.png" alt="„Ç∑„Éß„ÉÉ„Éó">
                „Ç∑„Éß„ÉÉ„Éó
            </a>
            <a href="slot.html">
                <img src="slot_icon.png" alt="„Çπ„É≠„ÉÉ„Éà">
                „Çπ„É≠„ÉÉ„Éà
            </a>
        </nav>

        <div id="user-badge">
            <span id="display-team">Ë™≠„ÅøËæº„Åø‰∏≠...</span>Ôºö<strong id="display-name"></strong> „Åï„Çì
            <a href="#" id="logout-link">„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
        </div>

        <h2>„Ç¢„Ç§„ÉÜ„É†Ë≥ºÂÖ•</h2>
        <div class="point-box">„ÉÅ„Éº„É†ÊâÄÊåÅ: <span id="points">--</span> P</div>

        <div id="item-list" class="item-grid"></div>
    </div>

    <script type="module">
        // ‚ñº‚ñº‚ñº SHOP_WEBHOOK_URL „Çí„Ç§„É≥„Éù„Éº„Éà ‚ñº‚ñº‚ñº
        import { db, getUserInfo, SHOP_WEBHOOK_URL } from './config.js';
        import { ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const user = getUserInfo();
        if (user) {
            document.getElementById('display-team').innerText = user.teamName;
            document.getElementById('display-name').innerText = user.name;
            onValue(ref(db, `teams/${user.teamId}/points`), (s) => {
                document.getElementById('points').innerText = s.val() || 0;
            });
        }

        // „Ç¢„Ç§„ÉÜ„É†ÂÆöÁæ© 
        const ITEMS = [
            { id: 1, name: "ÊπñÁïî„Å∏ËªäÁßªÂãï", cost: 50, img: "car.png" },
            { id: 2, name: "„Ç≥„É≥„Éì„ÉãÊ®©", cost: 500, img: "lawson.png" },
            { id: 3, name: "„Ç´„ÉÉ„Éó„É©„Éº„É°„É≥", cost: 200, img: "cupnoodle.png" },
            { id: 4, name: "„Çπ„Ç§„ÉÉ„ÉÅ", cost: 1000, img: "switch.png" }
        ];

        const listContainer = document.getElementById('item-list');
        ITEMS.forEach(item => {
            listContainer.innerHTML += `
                <div class="item-card">
                    <img src="${item.img}" alt="${item.name}">
                    <h4>${item.name}</h4>
                    <p>${item.cost} P</p>
                    <button onclick="purchase('${item.name}', ${item.cost})">Ê≥®Êñá„Åô„Çã</button>
                </div>
            `;
        });

        window.purchase = (itemName, cost) => {
            if (!confirm(`${itemName}„Çí${cost}P„ÅßË≥ºÂÖ•„Åó„Åæ„Åô„ÅãÔºü`)) return;
            const pRef = ref(db, `teams/${user.teamId}/points`);
            runTransaction(pRef, (p) => {
                if (p === null || p < cost) return; 
                return p - cost;
            }).then((result) => {
                if (!result.committed) { alert("„Éù„Ç§„É≥„Éà„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ"); } else {
                    // „Ç∑„Éß„ÉÉ„ÉóÂ∞ÇÁî®Webhook„Å∏ÈÄÅ‰ø°
                    fetch(SHOP_WEBHOOK_URL, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ content: `üõí **Ê≥®Êñá**: ${user.teamName} „ÅÆ ${user.name} „Åï„Çì„Åå„Äå${itemName}„Äç„ÇíË≥ºÂÖ• (-${cost}P)` })
                    });
                    alert("Ë≥ºÂÖ•„Åó„Åæ„Åó„ÅüÔºÅ");
                }
            });
        };
        document.getElementById('logout-link').onclick = () => { localStorage.removeItem('userId'); window.location.href = 'login.html'; };
    </script>
</body>
</html>
