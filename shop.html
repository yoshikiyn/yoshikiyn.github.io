<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ã‚¤ãƒ†ãƒ ã‚·ãƒ§ãƒƒãƒ—</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav>
            <a href="shop.html" class="active">
                <img src="shop_icon.png" alt="ã‚·ãƒ§ãƒƒãƒ—">
                ã‚·ãƒ§ãƒƒãƒ—
            </a>
            <a href="slot.html">
                <img src="slot_icon.png" alt="???">
                ï¼Ÿï¼Ÿï¼Ÿ
            </a>
        </nav>

        <div id="user-badge">
            <span id="display-team">èª­ã¿è¾¼ã¿ä¸­...</span>ï¼š<strong id="display-name"></strong> ã•ã‚“
            <a href="#" id="logout-link">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
        </div>

        <h2>ã‚¢ã‚¤ãƒ†ãƒ è³¼å…¥</h2>
        <div class="point-box">ãƒãƒ¼ãƒ æ‰€æŒ: <span id="points">--</span> P</div>

        <div id="item-list" class="item-grid"></div>
        <p class ="shop-disclaimer">â€»å•†å“ç”»åƒã¯ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚</p>
    </div>

    <div id="custom-confirm" class="modal-overlay" style="display:none;">
        <div class="modal-card">
            <h3 id="confirm-msg">è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ</h3>
            <div class="modal-btns">
                <button id="confirm-yes" class="btn-primary">ã¯ã„</button>
                <button id="confirm-no" class="btn-secondary">ã„ã„ãˆ</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast-msg">è³¼å…¥ãŒå®Œäº†ã—ã¾ã—ãŸï¼</div>

<script type="module">
        import { db, getUserInfo, SHOP_WEBHOOK_URL } from './config.js';
        import { ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const user = getUserInfo();
        if (user) {
            document.getElementById('display-team').innerText = user.teamName;
            document.getElementById('display-name').innerText = user.name;
            onValue(ref(db, `teams/${user.teamId}/points`), (s) => {
                document.getElementById('points').innerText = (s.val() || 0).toLocaleString();
            });
        }

        // ã‚¢ã‚¤ãƒ†ãƒ å®šç¾©
        const ITEMS = [
            { id: 1, name: "ã‚«ãƒƒãƒ—ãƒ©ãƒ¼ãƒ¡ãƒ³", cost: 350, img: "cupnoodle.png" },
            { id: 2, name: "ãƒãƒ†ãƒ", cost: 300, img: "potato.png" },
            { id: 3, name: "æ¹–ç•”ã¸è»Šç§»å‹•(å¾€å¾©)", cost: 50, img: "car.png" },
            { id: 4, name: "ã‚³ãƒ³ãƒ“ãƒ‹æ¨©", cost: 500, img: "lawson.png" },
            { id: 5, name: "ã‚¹ã‚¤ãƒƒãƒ", cost: 1000, img: "switch.png"},
            { id: 6, name: "???(MEN ONLY)", cost: 2500, img: "quest.png"}
        ];

        const listContainer = document.getElementById('item-list');
        ITEMS.forEach(item => {
            listContainer.innerHTML += `
                <div class="item-card">
                    <img src="${item.img}" alt="${item.name}">
                    <h4>${item.name}</h4>
                    <p>${item.cost} P</p>
                    <button onclick="buyItem('${item.name}', ${item.cost})">æ³¨æ–‡ã™ã‚‹</button>
                </div>
            `;
        });

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        window.buyItem = (itemName, price) => {
            const modal = document.getElementById('custom-confirm');
            const msgEl = document.getElementById('confirm-msg');
            
            if (!modal || !msgEl) return;

            msgEl.innerText = `${itemName} ã‚’è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ`;
            modal.style.display = 'flex';

            // ã€Œã¯ã„ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
            document.getElementById('confirm-yes').onclick = () => {
                modal.style.display = 'none';
                const itemPrice = parseInt(price);

                runTransaction(ref(db, `teams/${user.teamId}/points`), (currentPoints) => {
                    const p = currentPoints || 0;
                    if (p < itemPrice) return; // ãƒã‚¤ãƒ³ãƒˆä¸è¶³ãªã‚‰ä¸­æ–­
                    return p - itemPrice;
                }).then((res) => {
                    if (!res.committed) {
                        showToast("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼");
                        return;
                    }

                    // --- è³¼å…¥æˆåŠŸå¾Œã®å‡¦ç† ---
                    // 1. Webhooké€šçŸ¥
                    fetch(SHOP_WEBHOOK_URL, {
                        method: "POST",
                        headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({ 
                            content: `ğŸ›’ **SHOP**: ${user.teamName}ã®${user.name}ã•ã‚“ãŒã€Œ${itemName}ã€ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼` 
                        })
                    });

                    // 2. å®Œäº†é€šçŸ¥ã‚’è¡¨ç¤º
                    showToast(`${itemName} ã‚’è³¼å…¥ã—ã¾ã—ãŸï¼`);

                }).catch(err => {
                    console.error("è³¼å…¥ã‚¨ãƒ©ãƒ¼:", err);
                    showToast("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                });
            };

            // ã€Œã„ã„ãˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
            document.getElementById('confirm-no').onclick = () => {
                modal.style.display = 'none';
            };
        };

        document.getElementById('logout-link').onclick = (e) => { 
            e.preventDefault();
            localStorage.removeItem('userId'); 
            window.location.href = 'login.html'; 
        };
    </script>
</body>
</html>
