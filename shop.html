<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç¢„Ç§„ÉÜ„É†„Ç∑„Éß„ÉÉ„Éó</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #user-badge { text-align: right; padding: 10px; font-size: 0.9em; color: #555; background: #eee; border-radius: 5px; margin-bottom: 15px; }
        .item-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .item-card { background: #fff; border: 1px solid #ddd; padding: 15px; text-align: center; border-radius: 8px; transition: transform 0.2s; }
        .item-card:active { transform: scale(0.98); }
        .item-card img { width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px; }
        .item-card h4 { margin: 10px 0 5px 0; }
        .item-card p { color: #28a745; font-weight: bold; margin-bottom: 10px; }
        .item-card button { width: 100%; background: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <div id="user-badge">
            <span id="display-team">Ë™≠„ÅøËæº„Åø‰∏≠...</span>Ôºö<strong id="display-name"></strong> „Åï„Çì
            <br>
            <a href="#" id="logout-link" style="font-size: 0.8em; color: #999;">„É≠„Ç∞„Ç¢„Ç¶„Éà</a>
        </div>

        <nav>
            <a href="shop.html" class="active">„Ç∑„Éß„ÉÉ„Éó</a> | 
            <a href="slot.html">„Çπ„É≠„ÉÉ„Éà</a>
        </nav>

        <h2>„Ç¢„Ç§„ÉÜ„É†Ë≥ºÂÖ•</h2>
        <div class="point-box">„ÉÅ„Éº„É†ÊâÄÊåÅ„Éù„Ç§„É≥„Éà: <span id="points">--</span> P</div>

        <div id="item-list" class="item-grid">
            </div>
    </div>

    <script type="module">
        import { db, getUserInfo, DISCORD_WEBHOOK_URL } from './config.js';
        import { ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        //„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„ÅÆÂèñÂæó
        const user = getUserInfo();
        if (user) {
            document.getElementById('display-team').innerText = user.teamName;
            document.getElementById('display-name').innerText = user.name;
            
            // „ÉÅ„Éº„É†„ÅÆÂÖ±Êúâ„Éù„Ç§„É≥„Éà„Çí„É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ
            const pointRef = ref(db, `teams/${user.teamId}/points`);
            onValue(pointRef, (snapshot) => {
                document.getElementById('points').innerText = snapshot.val() || 0;
            });
        }

        //„Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà„ÅÆË®≠ÂÆö
        const ITEMS = [
            { id: 1, name: "ÊπñÁïî„Å∏ËªäÁßªÂãï", cost: 50, img: "car.png" },
            { id: 2, name: "„Ç≥„É≥„Éì„ÉãÊ®©", cost: 500, img: "lawson.png" },
            { id: 3, name: "„Ç´„ÉÉ„Éó„É©„Éº„É°„É≥", cost: 200, img: "cupnoodle.png" },
            { id: 4, name: "„Çπ„Ç§„ÉÉ„ÉÅ", cost: 1000, img: "switch.png" }
        ];

        // 3. „Ç∑„Éß„ÉÉ„ÉóÁîªÈù¢„ÅÆÁîüÊàê
        const listContainer = document.getElementById('item-list');
        ITEMS.forEach(item => {
            const card = document.createElement('div');
            card.className = "item-card";
            card.innerHTML = `
                <img src="${item.img}" alt="${item.name}">
                <h4>${item.name}</h4>
                <p>${item.cost} P</p>
                <button onclick="purchase('${item.name}', ${item.cost})">Ê≥®Êñá„Åô„Çã</button>
            `;
            listContainer.appendChild(card);
        });

        //Ë≥ºÂÖ•Âá¶ÁêÜÔºàÂÄã‰∫∫Âêç„ÇíÂê´„ÇÅ„ÅüWebhookÈÄöÁü•Ôºâ
        window.purchase = (itemName, cost) => {
            if (!confirm(`„ÄêÁ¢∫Ë™ç„Äë\n${itemName}„Çí${cost}P„ÅßË≥ºÂÖ•„Åó„Åæ„Åô„ÅãÔºü\n(Discord„Å´ÈÄöÁü•„Åï„Çå„Åæ„Åô)`)) return;

            const pRef = ref(db, `teams/${user.teamId}/points`);

            runTransaction(pRef, (currentPoints) => {
                if (currentPoints === null || currentPoints < cost) return; 
                return currentPoints - cost;
            }).then((result) => {
                if (!result.committed) {
                    alert("„Éù„Ç§„É≥„Éà„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ");
                } else {
                    // DiscordÈÄöÁü•„ÅÆÈÄÅ‰ø°
                    const discordMsg = `üõí **„Ç¢„Ç§„ÉÜ„É†Ê≥®ÊñáÈÄöÁü•**\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n**„ÉÅ„Éº„É†**: ${user.teamName}\n**Ê≥®ÊñáËÄÖ**: ${user.name} „Åï„Çì\n**ÂÜÖÂÆπ**: ${itemName}\n**Ê∂àË≤ª**: ${cost} P`;
                    
                    fetch(DISCORD_WEBHOOK_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ content: discordMsg })
                    });

                    alert(`${itemName}„ÇíÊ≥®Êñá„Åó„Åæ„Åó„ÅüÔºÅÁÆ°ÁêÜËÄÖ„ÅÆÊåáÁ§∫„Å´Âæì„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                }
            }).catch(err => {
                console.error(err);
                alert("ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ");
            });
        };

        // „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
        document.getElementById('logout-link').onclick = (e) => {
            e.preventDefault();
            localStorage.removeItem('userId');
            window.location.href = 'login.html';
        };
    </script>
</body>
</html>
