<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRコードスキャン</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container" style="text-align: center; padding: 50px 20px;">
        <h2 id="status-title">スキャンを確認中...</h2>
        <p id="status-msg">しばらくお待ちください。</p>
        
        <div id="loading-spinner" style="margin: 20px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>

        <button id="back-btn" class="btn-secondary" style="display:none; margin-top: 30px; width: 100%; max-width: 200px;">
            ショップへ戻る
        </button>
    </div>

    <div id="toast" class="toast-err"></div>

    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 成功時用の緑色トーストを追加 */
        .toast-success {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            opacity: 0; visibility: hidden; background: rgba(40, 167, 69, 0.95);
            color: white; padding: 12px 30px; border-radius: 30px; transition: all 0.4s;
            z-index: 10000; font-weight: bold;
        }
        .toast-success.show { bottom: 40px; opacity: 1; visibility: visible; }
    </style>

    <script type="module">
        import { db, getUserInfo } from './config.js';
        import { ref, runTransaction, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        //ログインチェック
        const userId = localStorage.getItem('userId');
        const currentUrl = window.location.href;

        if (!userId) {
            // 未ログインなら、このURLをログイン後に引き継げるようにして飛ばす
            window.location.href = `login.html?redirect=${encodeURIComponent(currentUrl)}`;
        } else {
            processScan();
        }

        async function processScan() {
            const urlParams = new URLSearchParams(window.location.search);
            const qrCode = urlParams.get('code');
            const user = getUserInfo();
        
            if (!qrCode) {
                updateStatus("エラー", "QRコードが指定されていません。", true);
                return;
            }
        
            const qrRef = ref(db, `qr_codes/${qrCode}`);
        
            try {
                // 1. まず、そのQRコードがDBに存在するか＆使用済みかを確認
                const snapshot = await get(qrRef);
                
                if (!snapshot.exists()) {
                    updateStatus("エラー", "このQRコードは登録されていません。", true);
                    return;
                }
        
                const data = snapshot.val();
                if (data.isUsed) {
                    updateStatus("残念...", "このQRコードはすでに誰かに使われています！", true);
                    return;
                }
        
                // 2. 問題なければ「早い者勝ち」の確定処理を実行
                const result = await runTransaction(qrRef, (currentData) => {
                    // ここでの null チェックは、同時実行時の衝突回避用
                    if (currentData === null) return currentData; 
                    if (currentData.isUsed) return; // 誰かが一瞬早く使った場合
        
                    return {
                        ...currentData,
                        isUsed: true,
                        usedBy: userId
                    };
                });
        
                // トランザクションが成功しなかった（一瞬の差で負けた）場合
                if (!result.committed) {
                    updateStatus("残念...", "一瞬の差で他の人に使われてしまいました！", true);
                    return;
                }
        
                // 3. ポイント付与処理
                const earnedPoints = data.points || 0;
                await runTransaction(ref(db, `teams/${user.teamId}/points`), (p) => {
                    return (p || 0) + earnedPoints;
                });
        
                updateStatus("獲得成功！", `${earnedPoints} P 手に入れました！`, false);
                showToast(`${earnedPoints} P ゲット！`, "success");
                
                // 3秒後に自動でショップへ
                setTimeout(() => window.location.href = 'shop.html', 3000);
        
            } catch (error) {
                console.error(error);
                updateStatus("エラー", "通信に失敗しました。電波の良い場所で試してください。", true);
            }
        }

        function updateStatus(title, msg, isError) {
            document.getElementById('status-title').innerText = title;
            document.getElementById('status-msg').innerText = msg;
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('back-btn').style.display = 'inline-block';
            if (isError) document.getElementById('status-title').style.color = '#d9534f';
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.className = type === "success" ? "toast-success" : "toast-err";
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        document.getElementById('back-btn').onclick = () => {
            window.location.href = 'shop.html';
        };
    </script>
</body>
</html>
