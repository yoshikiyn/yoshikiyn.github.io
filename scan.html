<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRコードスキャン</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container" style="text-align: center; padding: 50px 20px;">
        <h2 id="status-title">スキャンを確認中...</h2>
        <p id="status-msg">しばらくお待ちください。</p>
        
        <div id="loading-spinner" style="margin: 20px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>

        <button id="back-btn" style="display:none; margin-top: 20px;" onclick="location.href='shop.html'">ショップへ戻る</button>
    </div>

    <div id="toast" class="toast-err"></div>

    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 成功時用の緑色トーストを追加 */
        .toast-success {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            opacity: 0; visibility: hidden; background: rgba(40, 167, 69, 0.95);
            color: white; padding: 12px 30px; border-radius: 30px; transition: all 0.4s;
            z-index: 10000; font-weight: bold;
        }
        .toast-success.show { bottom: 40px; opacity: 1; visibility: visible; }
    </style>

    <script type="module">
        import { db, getUserInfo } from './config.js';
        import { ref, runTransaction, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        //ログインチェック
        const userId = localStorage.getItem('userId');
        const currentUrl = window.location.href;

        if (!userId) {
            // 未ログインなら、このURLをログイン後に引き継げるようにして飛ばす
            window.location.href = `login.html?redirect=${encodeURIComponent(currentUrl)}`;
        } else {
            processScan();
        }

        async function processScan() {
            const urlParams = new URLSearchParams(window.location.search);
            const qrCode = urlParams.get('code');
            const user = getUserInfo();

            if (!qrCode) {
                updateStatus("エラー", "無効なQRコードです。", true);
                return;
            }

            const qrRef = ref(db, `qr_codes/${qrCode}`);
            const spinner = document.getElementById('loading-spinner');

            try {
                const result = await runTransaction(qrRef, (currentData) => {
                    if (currentData === null) return;
                    if (currentData.isUsed) return;
                    
                    return {
                        ...currentData,
                        isUsed: true,
                        usedBy: userId
                    };
                });

                if (!result.committed) {
                    updateStatus("残念...", "このQRコードはすでに誰かに使われています！", true);
                    return;
                }

                // 2. ポイント付与
                const earnedPoints = result.snapshot.val().points || 0;
                await runTransaction(ref(db, `teams/${user.teamId}/points`), (p) => {
                    return (p || 0) + earnedPoints;
                });

                updateStatus("獲得成功！", `${earnedPoints} P 手に入れました！`, false);
                showToast(`${earnedPoints} P ゲット！`, "success");
                
                // 3秒後に自動でショップへ
                setTimeout(() => window.location.href = 'shop.html', 3000);

            } catch (error) {
                console.error(error);
                updateStatus("エラー", "処理中に問題が発生しました。", true);
            }
        }

        function updateStatus(title, msg, isError) {
            document.getElementById('status-title').innerText = title;
            document.getElementById('status-msg').innerText = msg;
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('back-btn').style.display = 'inline-block';
            if (isError) document.getElementById('status-title').style.color = '#d9534f';
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.className = type === "success" ? "toast-success" : "toast-err";
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
